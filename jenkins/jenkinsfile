// jenkins/jenkinsfile
pipeline {
    agent any 

    environment {
        // Tag de l'image
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        IMAGE_NAME = "mern-app"
        FULL_IMAGE = "${IMAGE_NAME}:${IMAGE_TAG}"
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
    }

    stages {
        
        // --- √âTAPE 1 : Construire l'image Docker ---
        stage('Build Docker Image') {
            steps {
                script {
                    echo "üî® Construction de l'image : ${FULL_IMAGE}"
                    // On construit l'image avec un tag simple
                    sh "docker build -t ${FULL_IMAGE} ."
                }
            }
        }

        // --- √âTAPE 2 : Cr√©er le Cluster Kind (Infra Terraform hors-Terraform) ---
        stage('Setup Kind Cluster') {
            steps {
                script {
                    echo "‚òÅÔ∏è D√©marrage du cluster Kind (mern-cluster)..."
                    // Suppression de l'ancien cluster s'il existe
                    sh 'kind delete cluster --name mern-cluster || true'
                    // Cr√©ation du nouveau cluster
                    sh 'kind create cluster --name mern-cluster'
                    // V√©rification de l'acc√®s (le kubeconfig est fusionn√© automatiquement)
                    sh 'kubectl cluster-info --context kind-mern-cluster'
                }
            }
        }
        
        // --- √âTAPE 3 : Charger l'image dans le Cluster Kind ---
        stage('Load Image into Kind') {
            steps {
                script {
                    echo "üì¶ Chargement de l'image ${FULL_IMAGE} dans Kind..."
                    // Transf√®re l'image directement depuis le Docker local vers les nodes Kind
                    sh "kind load docker-image ${FULL_IMAGE} --name mern-cluster"
                }
            }
        }

        // --- √âTAPE 4 : D√©ploiement de l'Application MERN (via Terraform) ---
        stage('Deploy with Terraform') {
            steps {
                script {
                    echo "üöÄ D√©marrage du d√©ploiement avec Terraform."
                    sh """
                        cd terraform
                        
                        echo "üîπ Init Terraform..."
                        terraform init
                        
                        echo "üîπ Apply Terraform..."
                        # On passe le tag unique √† Terraform
                        # L'image utilis√©e sera simplement 'mern-app:<tag>' car elle est d√©j√† charg√©e
                        terraform apply -auto-approve -var="image_tag=${IMAGE_TAG}"
                    """
                }
            }
        }
    }
}
