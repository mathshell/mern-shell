// jenkins/jenkinsfile
pipeline {
    // 1. DÃ©finir un agent
    agent any 

    // 2. DÃ©finir les variables d'environnement globales
    // C'est ICI qu'on dÃ©finit IMAGE_TAG pour qu'elle soit accessible partout
    environment {
        // Pour l'instant, on met 'latest'. 
        // IdÃ©alement, cela devrait Ãªtre "build-${env.BUILD_NUMBER}" pour Ãªtre unique.
        IMAGE_TAG = "latest"
    }

    // 3. Options globales (Pour rÃ©gler votre problÃ¨me de Timeout Git prÃ©cÃ©dent)
    options {
        timeout(time: 30, unit: 'MINUTES') // Donne 30 min au job avant de couper
    }

    // 4. DÃ©finir les Ã©tapes
    stages {
        
        // --- Ã‰tape 1 : Checkout (Automatique mais on peut le configurer si besoin) ---
        
        // --- Ã‰tape 2 : DÃ©ploiement Terraform ---
        stage('Deploy with Terraform') {
            steps {
                script {
                    // Le bloc 'sh' ouvre un terminal. Tout ce qui est dedans est du bash/shell.
                    sh """
                        echo "ðŸš€ DÃ©marrage du dÃ©ploiement pour l'image : ${IMAGE_TAG}"
                        
                        cd terraform
                        
                        # Initialisation
                        echo "ðŸ”¹ Init Terraform..."
                        terraform init
                        
                        # Application
                        echo "ðŸ”¹ Apply Terraform..."
                        
                        # CORRECTION ICI : On lance la commande terraform directement.
                        # Pas besoin de remettre 'sh "..."' autour.
                        terraform apply -auto-approve -var="image_tag=${IMAGE_TAG}"
                    """
                }
            }
        }
    }
}
